# 用户权限管理

## 1. 用户隔离的必要性
在系统架构中，用户通常分为两类：
- **系统数据库的管理员/用户**：用于管理系统设置、账套信息和用户权限等。
- **具体公司账套数据库的用户**：用于访问和操作特定公司账套的财务数据。

这两类用户应有不同的权限和访问控制策略，以确保安全性和数据隔离。

## 2. 数据库层的隔离
- **不同的数据库用户账号**：
  - 系统数据库和具体公司账套数据库应使用不同的数据库用户。
  - 系统数据库用户仅能访问系统数据库（如管理账套、系统设置、审计日志等），而公司账套数据库用户只能访问特定公司的账套数据。

### 实现方式
- 在数据库层面为每个数据库配置不同的用户，确保系统管理员无法随意访问客户数据。
- 对于公司账套数据库，采用最小权限原则，给予特定权限的用户访问特定公司的账套数据。

### 示例：MySQL 用户权限设置
```sql
-- 创建系统数据库的管理员用户
CREATE USER 'system_admin'@'localhost' IDENTIFIED BY 'password';
GRANT ALL PRIVILEGES ON system_db.* TO 'system_admin'@'localhost';

-- 创建公司账套的用户，限制只能访问特定的公司数据库
CREATE USER 'company_user'@'localhost' IDENTIFIED BY 'password';
GRANT SELECT, INSERT, UPDATE, DELETE ON company_123_db.* TO 'company_user'@'localhost';
```

## 3. 应用层的隔离
在 Node.js + Express 的架构中，可以通过以下方式确保不同用户只访问他们有权限的数据库：
- **动态切换数据库连接**：根据用户角色动态选择连接到不同的数据库。
- **访问控制**：每次用户登录时，根据角色信息决定用户能够访问的数据或数据库。

### 示例：Node.js 动态切换数据库
```javascript
const mysql = require('mysql');

// 系统数据库连接池
const systemDbPool = mysql.createPool({
  host: 'system-db-host',
  user: 'system-db-user',
  password: 'system-db-password',
  database: 'system_db',
});

// 获取具体公司账套数据库连接池
function getCompanyDbConnection(companyId) {
  return mysql.createPool({
    host: `company-${companyId}-db-host`,
    user: 'company-db-user',
    password: 'company-db-password',
    database: `company_${companyId}_db`,
  });
}

// 假设JWT中包含用户的角色和所属公司ID
const userRole = 'company'; // 或 'admin'
const companyId = 123;  // 假设是公司ID 123

if (userRole === 'admin') {
  // 如果是管理员，连接系统数据库
  systemDbPool.query('SELECT * FROM account_sets', (err, results) => {
    if (err) throw err;
    console.log(results);
  });
} else if (userRole === 'company') {
  // 如果是公司用户，连接对应的公司数据库
  const companyDb = getCompanyDbConnection(companyId);
  companyDb.query('SELECT * FROM vouchers', (err, results) => {
    if (err) throw err;
    console.log(results);
  });
}
```

## 4. 权限控制与审计
- **角色和权限控制**：通过不同的用户角色限制用户访问权限。
- **审计日志**：记录用户的每一次操作，确保可以追溯数据的修改历史。

## 5. 数据隔离的必要性
- **数据安全性**：防止不同公司的财务数据被泄露或错误访问。
- **合规性**：确保遵循数据隐私和保护法规（如中国的个人信息保护法、GDPR等）。

## 6. 总结
系统数据库的管理员用户和公司账套的用户应进行严格隔离。系统数据库用户只能管理系统层面的数据，而公司账套用户只能访问和操作其对应公司的财务数据。