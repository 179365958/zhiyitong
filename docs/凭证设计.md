# 凭证设计

## 后台实现

### 1. API 设计
设计以下主要接口来处理记账逻辑：

#### 新增凭证
- **接口路径**：`POST /api/vouchers`
- **功能**：接收凭证数据（包括凭证主表和分录），完成数据校验和入库。

#### 获取科目余额
- **接口路径**：`GET /api/balances`
- **功能**：根据会计期间和科目查询余额表。

#### 获取凭证列表
- **接口路径**：`GET /api/vouchers`
- **功能**：支持分页、筛选（按日期、凭证类型等）获取凭证数据。

#### 获取会计科目
- **接口路径**：`GET /api/subjects`
- **功能**：提供科目列表，用于前端录入分录时选择科目。

### 2. 核心记账逻辑
在新增凭证的接口中实现以下关键步骤：

#### (1) 数据校验
- **确保借贷平衡**：
```javascript
const totalDebit = entries.reduce((sum, entry) => sum + entry.debitAmount, 0);
const totalCredit = entries.reduce((sum, entry) => sum + entry.creditAmount, 0);
if (totalDebit !== totalCredit) {
    throw new Error('借贷金额不平衡');
}
```
- **验证科目是否存在**：查询 `account_subject` 表，确保所有科目合法。

#### (2) 数据库事务
使用事务保证多表操作的一致性：
- 插入 `voucher` 表记录（凭证主表）。
- 插入 `voucher_entry` 表记录（分录明细）。
- 更新 `subject_balance` 表记录（更新借贷金额）。
- 提交事务。

### 伪代码：
```javascript
const transaction = await db.transaction();
try {
    // 插入凭证主表
    const voucherId = await db.voucher.create(voucherData, { transaction });
    
    // 插入分录明细
    for (const entry of entries) {
        await db.voucherEntry.create({
            voucherId,
            ...entry
        }, { transaction });
    }

    // 更新科目余额
    for (const entry of entries) {
        const isDebit = entry.debitAmount > 0;
        await db.subjectBalance.update({
            [`${isDebit ? 'periodDebit' : 'periodCredit'}`]: db.sequelize.literal(
                `${isDebit ? 'periodDebit' : 'periodCredit'} + ${isDebit ? entry.debitAmount : entry.creditAmount}`
            ),
        }, {
            where: {
                periodId: periodId,
                subjectId: entry.subjectId
            },
            transaction
        });
    }

    // 提交事务
    await transaction.commit();
} catch (error) {
    await transaction.rollback();
    throw error;
}
```

### 3. 数据表设计
- **关键表**：
  - `voucher`：凭证主表，存储凭证编号、日期、摘要、总借贷金额。
  - `voucher_entry`：凭证分录表，存储分录科目、金额、摘要等。
  - `subject_balance`：科目余额表，按科目和会计期间跟踪余额。

### 4. 性能优化
- **批量插入**：使用批量插入代替逐行插入分录数据。
- **索引优化**：为 `voucher_entry.subject_id` 和 `subject_balance.period_id` 创建索引，加速查询。

## 前台实现

### 1. UI 设计
设计以下主要页面和交互：

#### 凭证录入页面
- 使用 Element Plus 提供表单和表格组件。
- 实现动态增减行的分录录入表格。
- 实时显示借贷金额汇总并检查是否平衡。

**功能点**：
- 下拉选择科目：从 `GET /api/subjects` 获取科目数据。
- 金额实时校验：借贷金额动态计算。
- 提交凭证：调用 `POST /api/vouchers`。

#### 凭证查询页面
- 使用分页表格显示凭证列表。
- 提供筛选条件（日期范围、凭证类型等）。

#### 科目余额表页面
- 使用 ECharts 显示科目余额图表。
- 提供表格模式显示余额明细。

### 2. 具体实现

#### (1) 凭证录入
- **分录表格**：
  - 使用 `el-table` 动态渲染分录行。
  - 实现“新增行”与“删除行”功能。
  - 下拉选择科目，绑定科目 id。

**示例代码**：
```vue
<el-form :model="voucherData">
    <el-table :data="entries" style="width: 100%">
        <el-table-column prop="subject" label="科目">
            <template slot-scope="scope">
                <el-select v-model="scope.row.subjectId" placeholder="选择科目">
                    <el-option
                        v-for="item in subjects"
                        :key="item.id"
                        :label="item.name"
                        :value="item.id">
                    </el-option>
                </el-select>
            </template>
        </el-table-column>
        <el-table-column prop="debitAmount" label="借方金额">
            <template slot-scope="scope">
                <el-input-number v-model="scope.row.debitAmount" />
            </template>
        </el-table-column>
        <el-table-column prop="creditAmount" label="贷方金额">
            <template slot-scope="scope">
                <el-input-number v-model="scope.row.creditAmount" />
            </template>
        </el-table-column>
    </el-table>
</el-form>
```

#### 提交接口
提交表单数据到后端：
```javascript
axios.post('/api/vouchers', {
    periodId: 1,
    voucherType: '记',
    entries: this.entries,
    summary: this.voucherData.summary
}).then(response => {
    this.$message.success('凭证保存成功！');
}).catch(error => {
    this.$message.error('保存失败，请检查数据！');
});
```

#### (2) 科目余额展示
- **表格模式**：使用 `el-table` 显示会计期间的科目余额数据，调用 `GET /api/balances`。
- **图表模式**：使用 ECharts 直观显示余额数据。

### 3. 用户体验优化
- **错误提示**：前台在提交数据时，捕获并展示后端的错误信息。
- **实时校验**：表单录入过程中，实时检查借贷是否平衡，减少用户提交错误。
- **导入导出功能**：支持 Excel 格式的凭证批量导入和导出。